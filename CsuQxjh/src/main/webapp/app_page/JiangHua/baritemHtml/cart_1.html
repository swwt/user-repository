<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>E3</title>
		<link rel="stylesheet" type="text/css" href="../css/mui.min.css" />
		<link rel="stylesheet" type="text/css" href="../css/iconfont.css" />
		<link rel="stylesheet" type="text/css" href="../css/own.css" />
		<script src="../jsHostName/hostName.js"></script>
		<style type="text/css">
			.table_head {
				padding-left: 15px;
				height: 30px;
				display: table-cell;
				vertical-align: middle;
			}
			
			.head_title {
				/*background-color: darkblue;*/
				position: relative;
				left: 10px;
				right: 10px;
			}
			
			.cellImg {
				max-width: 70%;
				height: auto;
				vertical-align: middle;
				position: relative;
				left: 5px;
			}
			
			.mui-table-view .mui-table-view-cell {
				background: #f3fcfb;
			}
			
			.mui-table-view .mui-table-view-cell:after {
				left: 0px;
			}
			
			.leftClassCell {
				float: left;
				width: 40%;
				text-align: center;
			}
			
			.rightClassCell {
				width: 60%;
				float: left;
			}
			
			.headSelect:visited {
				background-color: red;
			}
			
			.downDiv {
				background-color: white;
				height: 45px;
				width: 100%;
				/*网页底部*/
				position: fixed;
				bottom: 0;
			}
			
			.changeNum {
				padding: 0px;
				width: 30px;
				height: 30px;
				font-size: 30px;
			}
			
			.mui-icon.iconfont.icon-xuanze1,
			.mui-icon.iconfont.icon-xuanze {
				font-size: 1.1em;
				color: #41CEA9;
			}
			
			.head_title {
				vertical-align: baseline;
			}
			
			.mui-numbox {
				width: 40%;
				height: 100%;
				padding: 0px;
			}
			
			.mui-numbox [class*=mui-numbox-btn] {
				width: 30%;
				height: 100%;
				font-size: 1em;
				padding-bottom: 0.3em;
			}
			
			.itemName {
				color: black;
				line-height: 1.2em;
				font-size: 14px;
			}
			
			.itemfeatures {
				font-size: 0.6em;
				line-height: 0.5em;
				padding-top: 3px;
				margin-top: 7px;
			}
			
			.price {
				color: #ED2323;
				padding-top: 0px;
				margin-top: 0px;
			}
			/*选择图标设置 */
			
			.login {
				margin-bottom: 45px;
			}
			
			.login .table_head .mui-icon.icon-xuanze,
			.login .mui-table-view .mui-table-view-cell .mui-icon.icon-xuanze,
			.downDiv .leftDownDiv .summary .mui-icon.icon-xuanze {
				font-size: 18px;
				color: #ED2323;
			}
			
			.login .table_head .mui-icon.icon-xuanze1,
			.login .mui-table-view .mui-table-view-cell .mui-icon.icon-xuanze1,
			.downDiv .leftDownDiv .summary .mui-icon.icon-xuanze1 {
				font-size: 18px;
				color: gray;
				font-weight: 1;
			}
			
			.login .table_head .mui-icon.mui-icon-forward {
				margin-left: 5px;
				font-size: 20px;
			}
			/*downDiv 结算*/
			
			.downDiv .leftDownDiv {
				float: left;
				width: 70%;
				background-color: #fff;
				height: 45px;
			}
			
			.downDiv .rightDownDiv {
				float: left;
				width: 30%;
				background-color: #F23030;
				height: 45px;
				line-height: 45px;
				text-align: center;
				color: #fff;
				font-weight: bold;
			}
		</style>
		<script type="text/javascript">
			var orderStr;
		</script>
	</head>
		<script type="text/javascript">
			var cartJSONArrays=new Array();//购物车数组（json数组，cartId，amount）
			var dingdanMoneyTotal;
			var userId=JSON.parse(localStorage.getItem('user')).id;
		</script>
		
	<body>

		<div class="mui-content">
			<div class="need-login" style="text-align: center; margin-top: 50px;display: none;">
				<span style="color: gray; font-size: 0.9em;">你还没有登录</span>
				<br />
				<button type="button" class="mui-btn own-btn-green" style="margin-top: 10px; padding: 5px 20px;">请登录</button>
			</div>
			<div>
				<div class="login">
					<!--<input type="checkbox" />-->
					<div style="background-color:#FBFBFB;margin-top: 10px;">
						<p class="table_head" style="padding-bottom: 2pxs;height: 40px;">
							<span class="mui-icon iconfont icon-xuanze1 selectImg"></span>
							<img src="../img/shopIcon.png" class="selectImg" style="width: 1.3em;height: 1.3em;margin-left: 5px;" />
							<span class="head_title">江华商城</span>
							<span class="mui-icon mui-icon-forward"></span>
						</p>
						<ul class="mui-table-view" id="cartContent">
							<!--<li class="mui-table-view-cell mui-media" style="background-color: white;">
								<div class="leftClassCell">
									<span class="mui-icon iconfont icon-xuanze1 selectImg" style="float:left;margin-right: 10px;margin-top: 23px;"></span>
									<img src="../img/kinston.png" class="selectImg" style="float:left;width:80px;height: 80px;" />
								</div>

								<div class="rightClassCell">
									<div class="item-des">
										<p class="itemName mui-ellipsis-2">金士顿（Kingston）系统指定低电压版DDR3 1600 4GB</p>
										<p class="itemfeatures">颜色：红色/蓝色</p>
									</div>
									<div class="item-price-num" style="padding-top: 25px;">
										<p class="price" style="float: left;">￥100.00</p>
										<div class="mui-numbox" data-numbox-min='1' data-numbox-max='' style="float: right;width: 50%;">
											<button class="mui-btn mui-btn-numbox-minus" type="button">-</button>
											<input class="mui-input-numbox" type="number" value="1" />
											<input type="hidden" value="" />
											<button class="mui-btn mui-btn-numbox-plus" type="button">+</button>
										</div>
									</div>
								</div>
							</li>

							<li class="mui-table-view-cell mui-media" style="background-color: white;">
								<div class="leftClassCell">
									<span class="mui-icon iconfont icon-xuanze1 selectImg" style="float:left;margin-right: 10px;margin-top: 23px;"></span>
									<img src="../img/kinston.png" class="selectImg" style="float:left;width:80px;height: 80px;" />
								</div>

								<div class="rightClassCell">
									<div class="item-des">
										<p class="itemName mui-ellipsis-2">金士顿（Kingston）系统指定低电压版DDR3 1600 4GB</p>
										<p class="itemfeatures">颜色：红色/蓝色</p>
									</div>
									<div class="item-price-num" style="padding-top: 25px;">
										<p class="price" style="float: left;">￥100.00</p>
										<div class="mui-numbox" data-numbox-min='1' data-numbox-max='' style="float: right;width: 50%;">
											<button class="mui-btn mui-btn-numbox-minus" type="button">-</button>
											<input class="mui-input-numbox" type="number" value="1" />
											<input type="hidden" value="" />
											<button class="mui-btn mui-btn-numbox-plus" type="button">+</button>
										</div>
									</div>
								</div>
							</li>-->
						</ul>
					</div>
				
				</div>

				<div class="downDiv">
					<div class="leftDownDiv">
						<div class="summary" style="float: left;padding: 5px;">
						<!--	<span class="mui-icon iconfont icon-xuanze1 selectImg" style="float:left;margin-left: 10px;margin-top: 8px"></span>-->
							<span style="float: left;margin-left: 5px;margin-top: 6px;font-size: 12px;"></span>
						</div>
						<div id="cartSummary" style="float: left;margin-left: 5px;">
							<p id="cartSummary_1" style="font-weight:bold; font-size: 16px;color: #000;margin-top: 4px;margin-bottom: 0px;">合计:￥361.00</p>
							<p id="cartSummary_2" style="font-size: 10px;color: #222222;">￥361.00</p>
						</div>
					</div>
					<div id="purchase-div" class="rightDownDiv">

						去结算(<span id="cartNum">3</span>)

					</div>
				</div>
			</div>
		</div>
		<script src="../js/mui.min.js" charset="UTF-8"></script>
		<script src="../js/own.js" charset="UTF-8"></script>
		<script type="text/javascript" src="../js/wl_ajax.js"></script>
		<script type="text/javascript" charset="UTF-8">
			mui.init({
				swipeBack: false
			});
			var cartSupplierItem = [];
			var cartWebview; //当前购物车webview
			var needlogin; //需要登录的div
			var purchase_div; // 结算按钮
			var aniShow;
			var parentWebView;
			
			var downDiv;
			mui.plusReady(function() {
				cartWebview = plus.webview.currentWebview();
				parentWebView = cartWebview.parent();								
				needlogin = document.querySelector('.need-login');
				purchase_div = document.querySelector('#purchase-div');
				aniShow = getaniShow();
				downDiv = document.querySelector('.downDiv');
				
				var id = "Home/edit-order-needtem.html";
				var href = "Home/edit-order-needtem.html";
				var title = "填写订单";  //？ 
				var isBars = false;
				var barsIcon = '';
				/*
				 * 购物车结算并删除已结算的购物车中的商品
				 */
				function setOrder(cartData){
				//alert(cartData);
				plus.nativeUI.showWaiting('正在处理，请稍后...');
				
				mui.ajax(host+'/user/addGoodsOrderAndDeleteCart',{
						data:{
							userId:	userId,
							cartData:cartData 
						},
						async:true,
						dataType:'json',//服务器返回json格式数据
						type:'post',//HTTP请求类型
						timeout:10000,//超时时间设置为10秒；
						success:function(data){
							//服务器返回响应，根据响应结果，分析是否登录成功；							
							if(data.code==1){//登陆成功跳转到首页
								//alert(data.message);
								var orderJSON=data.result;
								orderStr=JSON.stringify(orderJSON);
								plus.nativeUI.closeWaiting();
								mui.fire(parentWebView, 'newWebView',{
									id: id,
									href: href,
									aniShow: aniShow,
									title: title,
									isBars: isBars,
									barsIcon: barsIcon,
									cartData:orderStr,
									dingdanMoneyTotal:dingdanMoneyTotal
								});
							addTop();
							}else{//登录失败，给出提醒
								alert(data.message);
							}
						},
						error:function(xhr,type,errorThrown){
							//异常处理；
							//console.log(type);
							alert("出现错误");
						}
					});
				}
				
				
				
				purchase_div.addEventListener('tap', function(){
					setTotal();
					var cartData=JSON.stringify(cartJSONArrays);
					
//					alert(dingdanMoneyTotal);

					//plus.nativeUI.showWaiting('订单正在处理...');
					//alert(cartData);
					if(cartJSONArrays.length==0){
						alert("请先去添加购物车");
						//plus.nativeUI.closeWaiting();
					}else{						
						setOrder(cartData);												
					}
				
				}, false);
				
				downDiv.style.display = 'block';
				//为登录按钮添加事件
				document.querySelector('.need-login button').addEventListener('tap', function() {
					var parentWebView = plus.webview.currentWebview().parent();
					var href = "Mine/login.html";
					var id = "Mine/login.html";
					var aniShow = 'slide-in-bottom';
					var title = '登录';
					mui.fire(parentWebView, 'newWebView', {
						id: id,
						href: href,
						aniShow: aniShow,
						title: title
					});
				}, false);
				//addTop();
				setTotal();
				//为页面显示的时候添加监听
				/*cartWebview.addEventListener('show',function(){
				//判断用户是否已经登录,已经登录就需要去获取购物车列表
				if (localStorage.getItem('user')) {
					//将登录按钮隐藏，并且去获取购物车列表或则更新购物车列表todo
					needlogin.style.display = 'none';
					
					if(cartSupplierItem.length <= 0) {
						
						ajax_get_cart({
							'type':'1'
						});
					}
					
	
				}else {
					//如果退出登录或者没有登录成功这个div将被显示出来。
					needlogin.style.display = 'block';
				}
			},false);*/
				//特殊：添加事件接收登录页面成功后发来的消息
				window.addEventListener('loginSuccess', function() {
					//页面成功后，要隐藏登录模块，然后去加载数据返回
					needlogin.style.display = 'none';
					ajax_get_cart({
						type: '1'
					});
				}, false);
			});

			function addTop() {
				mui('.mui-table-view').on('tap', 'span', function() {
					//				console.log(this.innerHTML);
					selectItem(this);
					countSeletNum();
					setTotal();
				});
				mui('.login div').on('tap', '.table_head', function() {
					var span = this.getElementsByTagName('span')[0];
					var isXuanze = selectItem(span);
					var objThis = span;
					var cellImgs = span.parentNode.parentNode.getElementsByClassName('selectImg');
					mui.each(cellImgs, function(index, item) {
						//去除第一个
						if (index >= 1) {
							if (isXuanze) {
								item.className = "mui-icon iconfont icon-xuanze selectImg";
							} else {
								item.className = "mui-icon iconfont icon-xuanze1 selectImg";
							}
						}
					});
					setTotal();
					countSeletNum();
				});
				var span = document.querySelector('.downDiv .leftDownDiv .summary span');
				span.addEventListener('tap', function() {
					alert(1);
					var isSelect = selectItem(span);
					var objThis = span;
					var cellImgs = document.getElementsByClassName('selectImg');
					mui.each(cellImgs, function(index, item) {
						//alert(isSelect);
						if (isSelect) {
							item.className = "mui-icon iconfont icon-xuanze selectImg";
						} else {
							item.className = "mui-icon iconfont icon-xuanze1 selectImg";
						}
					});
					setTotal();
					//countSeletNum();
				}, false);
				//手动写增加减少
				mui('.mui-numbox').on('tap', '.mui-numbox-btn-minus', function() {
					var inputNumbox = this.nextSibling;
					var num = parseInt(inputNumbox.value);
					if (num > 1) {
						num -= 1;
						inputNumbox.value = '' + num;
					}
					setTotal(); 
				});
				mui('.mui-numbox').on('tap', '.mui-numbox-btn-plus', function() {
					
					var inputNumbox = this.previousSibling;
					var num = parseInt(inputNumbox.value);
					num += 1;
					inputNumbox.value = '' + num;
					setTotal();
				});
			}

			function selectItem(obj) {
				
				var isXuanze = obj.classList.contains('icon-xuanze1');
				//alert(isXuanze); 
				if (isXuanze) {
					obj.className = "mui-icon iconfont icon-xuanze selectImg";
				} else {
					obj.className = "mui-icon iconfont icon-xuanze1 selectImg";
				}
				setTotal();
				return isXuanze;
			}

			function countSeletNum() {
				var selectedItems = document.getElementsByClassName("icon-xuanze");
				var sum = 0;
				mui.each(selectedItems, function(index, item) {
					var isContain = item.parentNode.classList.contains("leftClassCell");
					if (isContain) {
						sum = sum + 1;
					}
				});
				document.getElementById('cartNum').innerText = sum;
				//			var downDivHidden = true;
				//			var cellImgs = document.getElementsByClassName('selectImg');
				//			for (var i = 0; i < cellImgs.length; i ++) {
				//				
				//				var cellImg = cellImgs[i];
				//				var num = cellImg.src.indexOf("iconfont-xuanze.png");
				//				if (num > 1) {
				//					
				//					downDivHidden = false;
				//					break;
				//				}
				//			}
				//			
				//			if(downDivHidden == false) {
				//				
				//				downDiv.style.display = 'block';
				//			}else {
				//				
				//				downDiv.style.display = 'none';
				//			}
				setTotal();
			}

			function getCartItem(data) {
				//alert("getCartItem");
				var suppliers = data.suppliers;
				var cartItems = data.group_cart_items;
				for (var i = 0; i < suppliers.length; i++) {
					var supplier = suppliers[i];
					var cartSupplier = new Object;
					cartSupplier.supplier_name = supplier.supplier_name;
					cartSupplier.supplier_id = supplier.supplier_id;
					for (var j = 0; j < cartItems.length; j++) {
						var item = new Object;
						item = cartItems[j];
						if (cartSupplier.supplier_id == item.supplier_id) {
							cartSupplier.products = item.products;
							break;
						}
					}
					cartSupplierItem[i] = cartSupplier;
				}
				setHtml(cartSupplierItem);
				addTop();
			}

			function setHtml(items) {
				//alert("setHtml");
				var loginDiv = document.querySelector('.login');
				var html = '';
				mui.each(items, function(index, item) {
					console.log(JSON.stringify(item));
					//结构 <div>head+table</div>
					var listDiv = '';
					listDiv += '<div >';
					//标题 head
					//结构<p>img + span</p>
					var listHead = '';
					listHead += '<p class="table_head">';
					listHead += '<span class="mui-icon iconfont icon-xuanze1 selectImg"></span>';
					//				listHead += '<img src="../img/iconfont-xuanzekuang.png" class="selectImg"/>';
					listHead += '<span class="head_title">' + item.supplier_name + '</span>';
					listHead += '</p>';
					listDiv += listHead;
					listDiv += '<ul class="mui-table-view">';
					var listCellStr = '';
					mui.each(item.products, function(i, product) {
						listCellStr += '<li class="mui-table-view-cell mui-media">';
						//左边div
						var leftCellDiv = '';
						leftCellDiv += '<div class="leftClassCell">';
						leftCellDiv += '<p style="display:inline;"><span class="mui-icon iconfont icon-xuanze1 selectImg"></span></p>';
						//					leftCellDiv += '<img src="../img/iconfont-xuanzekuang.png" class="selectImg" />';
						leftCellDiv += '<img src="http://file.huihoo.com' + product.product_small_image_url + '"class="cellImg" />';
						leftCellDiv += '</div>';
						listCellStr += leftCellDiv;
						//右边div
						var rightCellDiv = '';
						rightCellDiv += '<div class="rightClassCell">';
						rightCellDiv += '<p class="itemName mui-ellipsis-2">' + product.product_name + '</p>';
						var features = product.features;
						if (features) {
							rightCellDiv += '<p class="itemfeatures">' + features[0].product_feature_type_id + ':' + features[0].description + '</p>';
						}
						rightCellDiv += '<p class="price">' + '¥' + product.default_price + '.00' + '</p>';
						rightCellDiv += '<div class="mui-numbox"><button class="mui-btn mui-numbox-btn-minus" type="button">-</button><input class="mui-numbox-input" type="number"  value="1"/><button class="mui-btn mui-numbox-btn-plus" type="button">+</button></div>';
						rightCellDiv += '</div>';
						listCellStr += rightCellDiv;
						listCellStr += '</li>';
					});
					listDiv += listCellStr + '</ul>';
					listDiv += '</div>'
					html += listDiv;
					console.log(html);
				});
				loginDiv.innerHTML = html;
			}
			/*
			 * 获取所有购物车内容
			 */
			function getShoppingCarts(){
				
				mui.ajax(host+'/user/getShoppingCart',{
						data:{
							userId:	userId						
						},
						dataType:'json',//服务器返回json格式数据
						type:'post',//HTTP请求类型
						timeout:10000,//超时时间设置为10秒；
						success:function(data){
							//服务器返回响应，根据响应结果，分析是否登录成功；							
							if(data.code==1){//登陆成功跳转到首页
								//alert(data.message);
								
								var shoppingCartJSON=data.result;
								var shoppingCartHtml="";
								for(var k=0;k<shoppingCartJSON.length;k++){
									var cart=shoppingCartJSON[k];
									//alert(cart.shopping_cart_price);
									var images=cart.goods.images;
									shoppingCartHtml=shoppingCartHtml
										+"<li class=\"mui-table-view-cell mui-media\" style=\"background-color: white;\">"
											+"<div class=\"leftClassCell\">"
												+"<span class=\"mui-icon iconfont icon-xuanze1 selectImg\" style=\"float:left;margin-right: 10px;margin-top: 23px;\"></span>"
												+"<img src=\""+host+images[0].goods_image_src+"\" style=\"float:left;width:80px;height: 80px;\" />"
											+"</div>"	
											+"<div class=\"rightClassCell\">"
												+"<div class=\"item-des\">"
													+"<p class=\"itemName mui-ellipsis-2\">"+cart.goods.goods_name+"("+cart.shopping_cart_price_description+")"	+"</p>"			
												+"</div>"
												+"<div class=\"item-price-num\" style=\"padding-top: 25px;\">"
													+"<p class=\"price\" style=\"float: left;\">￥"+cart.shopping_cart_price+"</p>"
													+"<div class=\"mui-numbox\" data-numbox-min='1' data-numbox-max='' style=\"float: right;width: 50%;\">"
														+"<button class=\"mui-btn mui-btn-numbox-minus\" type=\"button\">-</button>"
														+"<input class=\"mui-input-numbox\" type=\"number\" value=\"1\" readonly=\"readonly\"/>"
														+"<input type=\"hidden\" value=\""+cart.id+"\" />"
														+"<button class=\"mui-btn mui-btn-numbox-plus\" type=\"button\">+</button>"
													+"</div>"
												+"</div>"
											+"</div>"
										+"</li>";	
								}
							document.getElementById("cartContent").innerHTML=shoppingCartHtml;
							
							mui('.mui-numbox').numbox();
							
							addTop();
							}else{//登录失败，给出提醒
								alert(data.message);
							}
						},
						error:function(xhr,type,errorThrown){
							//异常处理；
							//console.log(type);
							alert("出现错误");
						}
					});
			}
		/*
		 * 动态统计总金额
		 */
		function setTotal(){//合计
			var shoppingCartUl=document.getElementsByTagName("ul");
			var shoppingCartLi=shoppingCartUl[0].getElementsByTagName("li");
//			alert(document.querySelector('.downDiv .leftDownDiv .summary span').classList.contains('icon-xuanze1'));
			//alert(shoppingCartLi[0].getElementsByTagName("span").className);
//			var span=shoppingCartLi[1].getElementsByTagName("span");
//			alert(span[0].classList.get(2));
//			var span = document.querySelector('.downDiv .leftDownDiv .summary span');
			var totalMoney=0;//选中的商品的总钱数
			var jiesuanAmount=0;
			cartJSONArrays=new Array();
			for(var n=0;n<shoppingCartLi.length;n++){
				var li=shoppingCartLi[n];
				var price=li.getElementsByClassName("price");
				var priceStr=price[0].innerHTML;
				//alert(priceStr);
				var price1=parseFloat(priceStr.substring(1,priceStr.length)); 
				//alert(price1);
				var inputList=li.getElementsByTagName("input");
				var amount=parseInt(inputList[0].value);
				var cart_id=parseInt(inputList[1].value);
				//alert(amount);
				var span=li.getElementsByTagName("span");
				var xuanzhong=span[0].classList.contains('icon-xuanze');
				if(xuanzhong){
					cartJSONArrays[jiesuanAmount]={'cart_id':cart_id,'amount':amount};//一个json对象代表购物车对应的一个商品
					jiesuanAmount=jiesuanAmount+1;
					totalMoney=totalMoney+parseInt(amount)*price1;
					
				}
				
			}
			dingdanMoneyTotal=totalMoney;
			//alert(totalMoney);
			totalMoney=parseFloat(totalMoney).toFixed(3);
			document.getElementById("cartSummary_1").innerHTML="合计:￥"+totalMoney;
			document.getElementById("cartSummary_2").innerHTML="￥"+totalMoney;
			document.getElementById("cartNum").innerHTML=jiesuanAmount;
		}
		</script>
	</body>
	<script type="text/javascript">
		getShoppingCarts();
	</script>
	<script type="text/javascript">
	mui.plusReady(function() {
		currentWebview = plus.webview.currentWebview();
		currentWebview.addEventListener('show',function(){//每进入页面一次就刷新一次				
					if(plus.networkinfo.getCurrentType()==1){
						alert("当前没有网络");
					}else{
						//alert(plus.webview.currentWebview().id);
						//getCatagory(); 
						location.reload();
					}					
		});
	});	
	</script>
</html>